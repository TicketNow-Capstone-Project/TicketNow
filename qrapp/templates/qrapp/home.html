{% load static %}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html>
<head>
    <title>Driver QR Generator</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #qr-reader { width: 300px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Driver Registration</h1>
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Generate QR</button>
    </form>

    {% if qr_code %}
        <h2>Generated QR Code</h2>
        <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code"><br>
        <a href="{% static qr_filename %}" download>Download Saved QR Code</a>
    {% endif %}

    {% if qr_code %}
        <h2 class="text-xl font-bold mt-8 mb-2">Scan QR Code</h2>
        <div id="reader" class="border p-4 w-full max-w-md"></div>
        <p id="scan-result" class="mt-4 text-green-600 font-medium"></p>
    {% endif %}

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        // Camera Scanner
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById('scan-result').innerText = "Scanned QR Code: " + decodedText;
    }

    function onScanFailure(error) {
        // Optionally handle scan failures
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: 250 });

    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        // File Upload Scanner
        const uploadInput = document.getElementById('qr-upload');
        uploadInput.addEventListener('change', function () {
            if (uploadInput.files.length === 0) return;
            const file = uploadInput.files[0];
            const qrScanner = new Html5QrcodeScanner("qr-file-result", {}, false);
            Html5Qrcode.getCameras().then(() => {
                Html5Qrcode.scanFile(file, true)
                    .then(decodedText => {
                        document.getElementById("qr-file-result").innerText = decodedText;
                    })
                    .catch(err => {
                        document.getElementById("qr-file-result").innerText = "Unable to scan: " + err;
                    });
            });
        });
    </script>
</body>
</html>
